#!/usr/bin/env node
var ngxtslintreport=function(t){"use strict";function r(t){var r="/"===t.charAt(0),n="/"===i(t,-1);return(t=function(t,r){for(var n=0,e=t.length-1;0<=e;e--){var o=t[e];"."===o?t.splice(e,1):".."===o?(t.splice(e,1),n++):n&&(t.splice(e,1),n--)}if(r)for(;n--;)t.unshift("..");return t}(e(t.split("/"),function(t){return!!t}),!r).join("/"))||r||(t="."),t&&n&&(t+="/"),(r?"/":"")+t}function p(){return r(e(Array.prototype.slice.call(arguments,0),function(t,r){if("string"!=typeof t)throw new TypeError("Arguments to path.join must be strings");return t}).join("/"))}function e(t,r){if(t.filter)return t.filter(r);for(var n=[],e=0;e<t.length;e++)r(t[e],e,t)&&n.push(t[e]);return n}var o,n,i="b"==="ab".substr(-1)?function(t,r,n){return t.substr(r,n)}:function(t,r,n){return r<0&&(r=t.length+r),t.substr(r,n)},c=require("chalk"),s=require("fancy-log");function a(){this.logger=s}(n=o=o||{})[n.INFO=0]="INFO",n[n.DEBUG=1]="DEBUG",n[n.WARN=2]="WARN",n[n.ERROR=3]="ERROR";var u=new(a.prototype.info=function(t){this.formatAndPrint(o.INFO,t)},a.prototype.debug=function(t){this.formatAndPrint(o.DEBUG,t)},a.prototype.warn=function(t){this.formatAndPrint(o.WARN,t)},a.prototype.error=function(t){this.formatAndPrint(o.ERROR,t)},a.prototype.formatAndPrint=function(t,r){var n=r;switch(t){case o.INFO:n=c.green(r);break;case o.DEBUG:n=c.cyan(r);break;case o.WARN:n=c.yellow(r);break;case o.ERROR:n=c.red(r)}this.logger(n)},a),f=require("ora");function l(){}var h=new(l.prototype.show=function(t){var r={color:"magenta",spinner:"moon",text:t};this.loaderIndicator=f(r).start()},l.prototype.hide=function(){this.loaderIndicator.stop()},l),g="angular.json",d="package.json",m="ngx-tslint-report",y="tslint-report.json",T="tslint-report-config.json",v="ngx-ts-lint-report-template.hbs",x="index.html",R=require("fs-extra"),b=require("lodash"),A=require("npm-run"),E=require("handlebars"),w=require("detect-port"),P=process.cwd(),j=(require("http-server"),require("moment")),C=(F.prototype.initializIncrementHelper=function(){E.registerHelper("incIndex",function(t){return parseInt(t)+1})},F.prototype.checkForAngularProject=function(){var r=this;u.info("Generating TSLint report for project in "+P);var t=p(P,g);R.pathExists(t).then(function(t){t?r.checkForTslintReportConfig():u.error("Please use ngx-tslint-report for Angular2 application")}).catch(function(t){u.error("Please use ngx-tslint-report for Angular2 application")})},F.prototype.checkForTslintReportConfig=function(){var r=this,t=p(P,m,T);R.pathExists(t).then(function(t){t?r.readTslintReportConfig():(u.debug("TS lint report config doesn't exists"),r.copyTslintReportConfig())}).catch(function(t){u.error("Unable to find/create TS lint report config")})},F.prototype.copyTslintReportConfig=function(){var t=this;u.debug("Copying default tslint report config");var r=p(__dirname,"config",T),n=p(P,m,T);R.copy(r,n).then(function(){u.info("Copied default config"),t.readTslintReportConfig()}).catch(function(t){u.error(t),u.error("Unable to find/create TS lint report config"),process.exit(1)})},F.prototype.readTslintReportConfig=function(){var e=this,t=p(P,m,T);R.readJson(t).then(function(t){e.ngxTslintReportConfig=t;var r=p(P,m,y),n=e.buildTslintParams(t);R.ensureFile(r).then(function(){e.executeTslintScript(n)}).catch(function(t){u.error(t),process.exit(1)})}).catch(function(t){u.error(t),process.exit(1)})},F.prototype.buildTslintParams=function(t){var r=p(P,m,y),n="";return t.exclude&&0<t.exclude.length&&b.forEach(t.exclude,function(t){var r=p(P,t);n+="-e '"+r+"'"}),"tslint -c "+t.tslint+" -t json -o "+r+" -p "+t.tsconfig+" "+n+" --force"},F.prototype.executeTslintScript=function(t){var e=this;h.show("Analyzing project for TSlint errors"),A.exec(t,{cwd:P},function(t,r,n){t&&u.error(t),h.hide(),e.readTslintReport()})},F.prototype.readTslintReport=function(){var r=this;h.show("Processing TSLint errors");var t=p(P,m,y);R.readJson(t).then(function(t){h.hide(),r.processLintErrors(t)}).catch(function(t){u.error(t),process.exit(1)})},F.prototype.processLintErrors=function(n){var r=[],e={};b.forEach(n,function(t){t.name=t.name.replace(P,"")}),b.forEach(n,function(t){b.includes(r,t.name)?e[t.name]++:(r.push(t.name),e[t.name]=1)});var o=[];Object.keys(e).forEach(function(t,r){o.push({index:r+1,name:t,count:e[t],details:b.filter(n,{name:t})})}),this.bindTsLintErrorInfoWithTemplate(o,n.length)},F.prototype.bindTsLintErrorInfoWithTemplate=function(t,r){var n=this,e=R.readFileSync(p(P,d),"utf8"),o=JSON.parse(e),i={};i.total=r,i.errors=t,i.projectName=o.name,i.generatedDate=j().format("MMM Do YYYY, h:mm:ss a"),h.show("Generating Tslint report");var c=R.readFileSync(p(__dirname,"templates",v),"utf8"),s=E.compile(c,{})(i),a=p(P,m,x);R.outputFile(a,s).then(function(){h.hide(),u.info("Generated Tslint report"),u.warn("Total number of Tslint errors found: "+r),n.isPortAvailable(n.ngxTslintReportConfig.reportHostPort)}).catch(function(t){u.error(t),process.exit(1)})},F.prototype.isPortAvailable=function(r){var n=this;w(r).then(function(t){r!=t&&(r=t),n.launchNgxTslintReport(r)}).catch(function(t){u.error(t),process.exit(1)})},F.prototype.launchNgxTslintReport=function(t){var r="http-server "+p(P,m)+" -c10 -p "+t+" -o";A.exec(r,{cwd:P},function(t,r,n){t&&u.error(t)})},F);function F(){this.ngxTslintReportConfig={},this.checkForAngularProject(),this.initializIncrementHelper()}new C;return t.ReportGenerator=C,t}({});
