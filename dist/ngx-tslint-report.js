#!/usr/bin/env node
var ngxtslintreport=function(t){"use strict";function p(){var t,r,n,e=Array.prototype.slice.call(arguments,0);return t=o(e,function(t,r){if("string"!=typeof t)throw new TypeError("Arguments to path.join must be strings");return t}).join("/"),r="/"===t.charAt(0),n="/"===i(t,-1),(t=function(t,r){for(var n=0,e=t.length-1;0<=e;e--){var o=t[e];"."===o?t.splice(e,1):".."===o?(t.splice(e,1),n++):n&&(t.splice(e,1),n--)}if(r)for(;n--;n)t.unshift("..");return t}(o(t.split("/"),function(t){return!!t}),!r).join("/"))||r||(t="."),t&&n&&(t+="/"),(r?"/":"")+t}function o(t,r){if(t.filter)return t.filter(r);for(var n=[],e=0;e<t.length;e++)r(t[e],e,t)&&n.push(t[e]);return n}var e,r,i="b"==="ab".substr(-1)?function(t,r,n){return t.substr(r,n)}:function(t,r,n){return r<0&&(r=t.length+r),t.substr(r,n)},c=require("chalk"),n=require("fancy-log");(r=e||(e={}))[r.INFO=0]="INFO",r[r.DEBUG=1]="DEBUG",r[r.WARN=2]="WARN",r[r.ERROR=3]="ERROR";var u=new(function(){function t(){this.logger=n}return t.prototype.info=function(t){this.formatAndPrint(e.INFO,t)},t.prototype.debug=function(t){this.formatAndPrint(e.DEBUG,t)},t.prototype.warn=function(t){this.formatAndPrint(e.WARN,t)},t.prototype.error=function(t){this.formatAndPrint(e.ERROR,t)},t.prototype.formatAndPrint=function(t,r){var n=r;switch(t){case e.INFO:n=c.green(r);break;case e.DEBUG:n=c.cyan(r);break;case e.WARN:n=c.yellow(r);break;case e.ERROR:n=c.red(r)}this.logger(n)},t}()),s=require("ora"),f=new(function(){function t(){}return t.prototype.show=function(t){var r={color:"magenta",spinner:"moon",text:t};this.loaderIndicator=s(r).start()},t.prototype.hide=function(){this.loaderIndicator.stop()},t}()),a="angular.json",l="package.json",h="ngx-tslint-report",g="tslint-report.json",d="tslint-report-config.json",m="ngx-ts-lint-report-template.hbs",y="index.html",T=require("fs-extra"),v=require("lodash"),x=require("npm-run"),R=require("handlebars"),b=require("detect-port"),A=process.cwd(),E=(require("http-server"),require("moment")),w=function(){function t(){this.ngxTslintReportConfig={},this.checkForAngularProject(),this.initializIncrementHelper()}return t.prototype.initializIncrementHelper=function(){R.registerHelper("incIndex",function(t){return parseInt(t)+1})},t.prototype.checkForAngularProject=function(){var r=this;u.info("Generating TSLint report for project in "+A);var t=p(A,a);T.pathExists(t).then(function(t){t?r.checkForTslintReportConfig():u.error("Please use ngx-tslint-report for Angular2 application")}).catch(function(t){u.error("Please use ngx-tslint-report for Angular2 application")})},t.prototype.checkForTslintReportConfig=function(){var r=this,t=p(A,h,d);T.pathExists(t).then(function(t){t?r.readTslintReportConfig():(u.debug("TS lint report config doesn't exists"),r.copyTslintReportConfig())}).catch(function(t){u.error("Unable to find/create TS lint report config")})},t.prototype.copyTslintReportConfig=function(){var t=this;u.debug("Copying default tslint report config");var r=p(__dirname,"config",d),n=p(A,h,d);T.copy(r,n).then(function(){u.info("Copied default config"),t.readTslintReportConfig()}).catch(function(t){u.error(t),u.error("Unable to find/create TS lint report config"),process.exit(1)})},t.prototype.readTslintReportConfig=function(){var e=this,t=p(A,h,d);T.readJson(t).then(function(t){e.ngxTslintReportConfig=t;var r=p(A,h,g),n=e.buildTslintParams(t);T.ensureFile(r).then(function(){e.executeTslintScript(n)}).catch(function(t){u.error(t),process.exit(1)})}).catch(function(t){u.error(t),process.exit(1)})},t.prototype.buildTslintParams=function(t){var r=p(A,h,g),n="";return t.exclude&&0<t.exclude.length&&v.forEach(t.exclude,function(t){var r=p(A,t);n+="-e '"+r+"'"}),"tslint -c "+t.tslint+" -t json -o "+r+" -p "+t.tsconfig+" "+n+" --force"},t.prototype.executeTslintScript=function(t){var e=this;f.show("Analyzing project for TSlint errors"),x.exec(t,{cwd:A},function(t,r,n){t&&u.error(t),f.hide(),e.readTslintReport()})},t.prototype.readTslintReport=function(){var r=this;f.show("Processing TSLint errors");var t=p(A,h,g);T.readJson(t).then(function(t){f.hide(),r.processLintErrors(t)}).catch(function(t){u.error(t),process.exit(1)})},t.prototype.processLintErrors=function(n){var r=[],e={};v.forEach(n,function(t){t.name=t.name.replace(A,"")}),v.forEach(n,function(t){v.includes(r,t.name)?e[t.name]++:(r.push(t.name),e[t.name]=1)});var o=[];Object.keys(e).forEach(function(t,r){o.push({index:r+1,name:t,count:e[t],details:v.filter(n,{name:t})})}),this.bindTsLintErrorInfoWithTemplate(o,n.length)},t.prototype.bindTsLintErrorInfoWithTemplate=function(t,r){var n=this,e=T.readFileSync(p(A,l),"utf8"),o=JSON.parse(e),i={};i.total=r,i.errors=t,i.projectName=o.name,i.generatedDate=E().format("MMM Do YYYY, h:mm:ss a"),f.show("Generating Tslint report");var c=T.readFileSync(p(__dirname,"templates",m),"utf8"),s=R.compile(c,{})(i),a=p(A,h,y);T.outputFile(a,s).then(function(){f.hide(),u.info("Generated Tslint report"),u.warn("Total number of Tslint errors found: "+r),n.isPortAvailable(n.ngxTslintReportConfig.reportHostPort)}).catch(function(t){u.error(t),process.exit(1)})},t.prototype.isPortAvailable=function(r){var n=this;b(r).then(function(t){r!=t&&(r=t),n.launchNgxTslintReport(r)}).catch(function(t){u.error(t),process.exit(1)})},t.prototype.launchNgxTslintReport=function(t){var r="http-server "+p(A,h)+" -c10 -p "+t+" -o";x.exec(r,{cwd:A},function(t,r,n){t&&u.error(t)})},t}();new w;return t.ReportGenerator=w,t}({});
