#!/usr/bin/env node
var ngxtslintreport=function(t){"use strict";function p(){var t,n,r,e=Array.prototype.slice.call(arguments,0);return t=o(e,function(t,n){if("string"!=typeof t)throw new TypeError("Arguments to path.join must be strings");return t}).join("/"),n="/"===t.charAt(0),r="/"===i(t,-1),(t=function(t,n){for(var r=0,e=t.length-1;0<=e;e--){var o=t[e];"."===o?t.splice(e,1):".."===o?(t.splice(e,1),r++):r&&(t.splice(e,1),r--)}if(n)for(;r--;r)t.unshift("..");return t}(o(t.split("/"),function(t){return!!t}),!n).join("/"))||n||(t="."),t&&r&&(t+="/"),(n?"/":"")+t}function o(t,n){if(t.filter)return t.filter(n);for(var r=[],e=0;e<t.length;e++)n(t[e],e,t)&&r.push(t[e]);return r}var e,n,i="b"==="ab".substr(-1)?function(t,n,r){return t.substr(n,r)}:function(t,n,r){return n<0&&(n=t.length+n),t.substr(n,r)},c=require("chalk"),r=require("fancy-log");(n=e||(e={}))[n.INFO=0]="INFO",n[n.DEBUG=1]="DEBUG",n[n.WARN=2]="WARN",n[n.ERROR=3]="ERROR";var u=new(function(){function t(){this.logger=r}return t.prototype.info=function(t){this.formatAndPrint(e.INFO,t)},t.prototype.debug=function(t){this.formatAndPrint(e.DEBUG,t)},t.prototype.warn=function(t){this.formatAndPrint(e.WARN,t)},t.prototype.error=function(t){this.formatAndPrint(e.ERROR,t)},t.prototype.formatAndPrint=function(t,n){var r=n;switch(t){case e.INFO:r=c.green(n);break;case e.DEBUG:r=c.cyan(n);break;case e.WARN:r=c.yellow(n);break;case e.ERROR:r=c.red(n)}this.logger(r)},t}()),s=require("ora"),f=new(function(){function t(){}return t.prototype.show=function(t){var n={color:"magenta",spinner:"moon",text:t};this.loaderIndicator=s(n).start()},t.prototype.hide=function(){this.loaderIndicator.stop()},t}()),a="angular.json",l="package.json",h="ngx-tslint-report",g="tslint-report-config.json",d="ngx-ts-lint-report-template.hbs",y="index.html",T=require("fs-extra"),v=require("lodash"),m=require("npm-run"),R=require("handlebars"),x=require("detect-port"),b=process.cwd(),A=(require("http-server"),function(){function t(){this.ngxTslintReportConfig={},this.checkForAngularProject(),this.initializIncrementHelper(),this.initializLengthCheckHelper()}return t.prototype.initializIncrementHelper=function(){R.registerHelper("incIndex",function(t){return parseInt(t)+1})},t.prototype.initializLengthCheckHelper=function(){var e=this;R.registerHelper("ifLength",function(t,n,r){return t.length>n?r.fn(e):r.inverse(e)})},t.prototype.checkForAngularProject=function(){var n=this;u.info("Generating TSLint report for project in "+b);var t=p(b,a);T.pathExists(t).then(function(t){t?n.checkForTslintReportConfig():u.error("Please use ngx-tslint-report for Angular2 application")}).catch(function(t){u.error("Please use ngx-tslint-report for Angular2 application")})},t.prototype.checkForTslintReportConfig=function(){var n=this,t=p(b,h,g);T.pathExists(t).then(function(t){t?n.readTslintReportConfig():(u.debug("TS lint report config doesn't exists"),n.copyTslintReportConfig())}).catch(function(t){u.error("Unable to find/create TS lint report config")})},t.prototype.copyTslintReportConfig=function(){var t=this;u.debug("Copying default tslint report config");var n=p(__dirname,"config",g),r=p(b,h,g);T.copy(n,r).then(function(){u.info("Copied default config"),t.readTslintReportConfig()}).catch(function(t){u.error(t),u.error("Unable to find/create TS lint report config")})},t.prototype.readTslintReportConfig=function(){var e=this,t=p(b,h,g);T.readJson(t).then(function(t){e.ngxTslintReportConfig=t;var n=p(b,h,t.ngxtslintjson),r=e.buildTslintParams(t);u.error(r),T.ensureFile(n).then(function(){e.executeTslintScript(r)}).catch(function(t){u.error(t)})}).catch(function(t){u.error(t)})},t.prototype.buildTslintParams=function(t){var n=p(b,h,this.ngxTslintReportConfig.ngxtslintjson),r="";return t.exclude&&0<t.exclude.length&&v.forEach(t.exclude,function(t){var n=p(b,t);r+="-e '"+n+"'"}),"tslint -c "+t.tslint+" -t json -o "+n+" -p "+t.tsconfig+" "+r+" --force"},t.prototype.executeTslintScript=function(t){var e=this;f.show("Analyzing project for TSlint errors"),m.exec(t,{cwd:b},function(t,n,r){t&&u.error(t),f.hide(),e.readTslintReport()})},t.prototype.readTslintReport=function(){var n=this;f.show("Processing TSLint errors");var t=p(b,h,this.ngxTslintReportConfig.ngxtslintjson);T.readJson(t).then(function(t){f.hide(),n.processLintErrors(t)}).catch(function(t){u.error(t)})},t.prototype.processLintErrors=function(r){var n=[],e={};v.forEach(r,function(t){t.name=t.name.replace(b,"")}),v.forEach(r,function(t){v.includes(n,t.name)?e[t.name]++:(n.push(t.name),e[t.name]=1)});var o=[];Object.keys(e).forEach(function(t,n){o.push({index:n+1,name:t,count:e[t],details:v.filter(r,{name:t})})}),this.bindTsLintErrorInfoWithTemplate(o,r.length)},t.prototype.bindTsLintErrorInfoWithTemplate=function(t,n){var r=this,e=T.readFileSync(p(b,l),"utf8"),o=JSON.parse(e);u.error(o);var i={};i.total=n,i.errors=t,i.projectName=o.name,f.show("Generating Tslint report");var c=T.readFileSync(p(__dirname,"templates",d),"utf8"),s=R.compile(c,{})(i),a=p(b,h,y);T.outputFile(a,s).then(function(){f.hide(),u.info("Generated Tslint report"),u.warn("Total number of Tslint errors found: "+n),r.isPortAvailable(r.ngxTslintReportConfig.reportHostPort)}).catch(function(t){u.error(t)})},t.prototype.isPortAvailable=function(n){var r=this;x(n).then(function(t){n!=t&&(n=t),r.launchNgxTslintReport(n)}).catch(function(t){console.log(t)})},t.prototype.launchNgxTslintReport=function(t){var n="http-server "+p(b,h)+" -c10 -p "+t+" -o";m.exec(n,{cwd:b},function(t,n,r){t&&u.error(t)})},t}());new A;return t.ReportGenerator=A,t}({});
